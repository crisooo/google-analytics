WITH
  t1 AS (   # Tabla temporal. Landing con descuento
  SELECT
    date,
    clientId,
    "landing descuento" AS landing 
   FROM
    `allianz-marketing-data.216716148.ga_sessions_*`,
    UNNEST(hits) AS hits
  WHERE
    (_TABLE_SUFFIX BETWEEN "20200501"
      AND "20200624") #choose date range from the GA tables
  AND
    REGEXP_CONTAINS(hits.page.pagePath, "seguros-de-coches-allianz")),
  #end of temp table 1
  t2 AS (
  SELECT
    date,
    clientid,
    trafficSource.source,
    trafficSource.medium,
    trafficSource.campaign,
    trafficSource.keyword,
    hits.eventInfo.eventAction AS leadComercial
   FROM
    `allianz-marketing-data.216716148.ga_sessions_*`,
    UNNEST(hits) AS hits
  WHERE
    (_TABLE_SUFFIX BETWEEN "20200501"
      AND "20200624") #choose date range from the GA tables
  AND REGEXP_CONTAINS(hits.eventInfo.eventCategory, "LeadGenerado")
  AND REGEXP_CONTAINS(hits.eventInfo.eventAction, r"ClientePresupuesto|NoClientePresupuesto")),
  t3 AS (
  SELECT
    clientid,
    clean_fechaAlta,
    old_tipoSeguro AS tipoPolizaContratada
  FROM
    `jellyfish-gap.cris_test.offline_test`
 WHERE
 REGEXP_CONTAINS(clean_estado, "nueva poliza"))
SELECT
  t2.date, 
  t2.clientid,
  t2.source,
  t2.medium,
  t2.campaign,
  t2.keyword,
  t2.leadComercial,
  t3.clean_fechaAlta,
  t3.tipoPolizaContratada,
  t1.landing
FROM
  t2
LEFT JOIN
  t1 ON t2.clientId = t1.clientId
LEFT JOIN
  t3 ON t2.clientId = t3.clientId
  
  
  


#test environment
SELECT
  fullVisitorId,
  hits.page.pagePath,
  clientId,
  hits.customDimensions,
FROM jellyfish-gap.58325413.ga_sessions_20200501,
  UNNEST(hits) AS hits
#WHERE REGEXP_CONTAINS(hits.page.pagePath, "retornoform")  


SELECT
  fullVisitorId,
  hits.page.pagePath,
  clientId,
  hits.customDimensions,
FROM jellyfish-gap.58325413.ga_sessions_20200501,
  UNNEST(hits) AS hits
#WHERE REGEXP_CONTAINS(hits.page.pagePath, "retornoform")  
WHERE REGEXP_CONTAINS(hits.customDimensions.index, "7")




SELECT
  fullVisitorId,
  clientId,
  --,ARRAY( (SELECT AS STRUCT hitnumber, page.pagePath, transaction.transactionId FROM t.hits ) ) AS hitInfos -- test: show all hits in this session
FROM
  jellyfish-gap.58325413.ga_sessions_20200501 AS t 
  CROSS JOIN t.hits AS h
WHERE
  -- use the repeated hits nest (not the cross joined 'h') to check all pagePaths in the session
  (SELECT LOGICAL_OR(page.pagePath LIKE "retornoform") FROM t.hits )
  
  
  
  #FINAL QUERY
    SELECT
    clientId,
    REGEXP_EXTRACT(hits.page.pagePath, r"idlanding=([^&]*)") AS idlanding_value,
    trafficSource.source,
    trafficSource.medium,
    trafficSource.campaign,
    trafficSource.keyword,
    
  FROM
    `allianz-marketing-data.216716148.ga_sessions_*`,
    UNNEST(hits) AS hits
  WHERE
    (_TABLE_SUFFIX BETWEEN "20200511"
      AND "20200612") #choose date range from the GA tables
    AND REGEXP_CONTAINS(hits.page.pagePath, "retornoform")

  
